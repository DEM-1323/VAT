<!DOCTYPE html>
<html>
  <head>
    <title>Babylon.js VR Project</title>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        overflow: hidden;
      }
      #renderCanvas {
        width: 100%;
        height: 100%;
        touch-action: none;
        display: none; /* Hide canvas initially */
      }
      #startButton {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 10px 20px;
        font-size: 20px;
        cursor: pointer;
      }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>
  </head>
  <body>
    <button id="startButton">Start Experience</button>
    <canvas id="renderCanvas"></canvas>
    <script>
      document.getElementById("startButton").addEventListener("click", () => {
        document.getElementById("startButton").style.display = "none";
        document.getElementById("renderCanvas").style.display = "block";
        initializeScene();
      });

      function initializeScene() {
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);

        const createScene = function () {
          const scene = new BABYLON.Scene(engine);

          const camera = new BABYLON.ArcRotateCamera(
            "Camera",
            Math.PI / 2,
            Math.PI / 2,
            2,
            BABYLON.Vector3.Zero(),
            scene
          );
          camera.attachControl(canvas, true);

          const light = new BABYLON.HemisphericLight(
            "light",
            new BABYLON.Vector3(1, 1, 0),
            scene
          );

          const floor = BABYLON.MeshBuilder.CreateGround(
            "floor",
            { width: 10, height: 10 },
            scene
          );

          const floorMaterial = new BABYLON.StandardMaterial(
            "floorMaterial",
            scene
          );
          floorMaterial.diffuseColor = new BABYLON.Color3(0.5, 0.5, 0.5);
          floor.material = floorMaterial;

          BABYLON.SceneLoader.ImportMesh(
            "",
            "models/",
            "SAMII.glb",
            scene,
            function (meshes) {
              const importedMesh = meshes[0];
              importedMesh.position = new BABYLON.Vector3(0, 0, 0);
              setupTriggerPoints(importedMesh, scene);
            },
            null,
            function (scene, message, exception) {
              console.error("Error loading the model:", message, exception);
            }
          );

          const xrPromise = scene.createDefaultXRExperienceAsync({
            floorMeshes: [floor],
          });

          xrPromise
            .then((xr) => {
              const teleportation =
                xr.baseExperience.featuresManager.getEnabledFeature(
                  BABYLON.WebXRFeatureName.TELEPORTATION
                );

              if (teleportation) {
                teleportation.forceHandedness = "left";
                teleportation.useMainComponentOnly = true;
                teleportation.rotationEnabled = true;
                teleportation.rotationAngle = Math.PI / 8;
                teleportation.backwardsMovementEnabled = true;
                teleportation.backwardsTeleportationDistance = 0.7;
              }

              // Set up interaction detection after XR is initialized
              setupInteractionDetection(xr, scene);
            })
            .catch((error) => {
              console.error("Error initializing XR experience:", error);
            });

          return scene;
        };

        const scene = createScene();

        engine.runRenderLoop(function () {
          scene.render();
        });

        window.addEventListener("resize", function () {
          engine.resize();
        });
      }

      function setupTriggerPoints(importedMesh, scene) {
        const trigger1 = BABYLON.MeshBuilder.CreateSphere(
          "trigger1",
          { diameter: 0.1 },
          scene
        );
        trigger1.position = new BABYLON.Vector3(0, 0.5, 0.5);
        // trigger1.isVisible = false;
        trigger1.parent = importedMesh;

        const sound1 = new BABYLON.Sound(
          "sound1",
          "audio/Bronchial.mp3",
          scene,
          null,
          {
            loop: true,
            autoplay: false,
          }
        );

        // Store trigger and sound for later use
        scene.metadata = scene.metadata || {};
        scene.metadata.triggers = scene.metadata.triggers || [];
        scene.metadata.triggers.push({ trigger: trigger1, sound: sound1 });
      }

      function setupInteractionDetection(xr, scene) {
        const xrInput = xr.input;

        xrInput.onControllerAddedObservable.add((controller) => {
          const xrPointer = controller.pointer;

          scene.registerBeforeRender(() => {
            scene.metadata.triggers.forEach(({ trigger, sound }) => {
              if (xrPointer && xrPointer.intersectsMesh(trigger, false)) {
                if (!sound.isPlaying) {
                  sound.play();
                }
              } else {
                if (sound.isPlaying) {
                  sound.stop();
                }
              }
            });
          });
        });
      }
    </script>
  </body>
</html>
